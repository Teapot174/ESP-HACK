#include "Explorer.h"

static const unsigned char PROGMEM image_DolphinSaved_bits[] = {
  0x00,0x00,0x00,0x00,0x00,0x00,0x0f,0xff,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x30,0x00,0x70,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0x00,
  0x0c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x02,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x04,0x00,0x00,0x01,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x08,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,
  0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x10,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x40,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,
  0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x04,0x00,0x00,
  0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x03,0xe0,0x02,0x00,0x00,0x00,0x00,0x00,0x00,
  0x01,0x00,0x00,0x0c,0x18,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0xfd,0x00,0x00,0x10,
  0x04,0x01,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x00,0x00,0x23,0xf2,0x01,0x00,0x00,
  0x00,0x00,0x00,0x04,0x00,0xc0,0x00,0x24,0xfa,0x00,0x80,0x00,0x00,0x00,0x00,0x04,
  0x00,0x30,0x00,0x48,0x7d,0x00,0x80,0x00,0x00,0x00,0x00,0x08,0x00,0x0c,0x00,0x48,
  0x7d,0x00,0x80,0x00,0x00,0x00,0x00,0x08,0x00,0x03,0x00,0x4c,0xfd,0x00,0x80,0x00,
  0x00,0x00,0x00,0x09,0xf0,0x00,0xc0,0x4f,0xfd,0x00,0x80,0x00,0x00,0x00,0x00,0x0a,
  0x0c,0x00,0x30,0x5f,0xfd,0x00,0x80,0x00,0x00,0x00,0x00,0x0c,0x03,0x00,0x00,0x61,
  0xfe,0x00,0x40,0x00,0x00,0x00,0x00,0x04,0x00,0x80,0x00,0x80,0x7a,0x00,0x40,0x00,
  0xff,0xfc,0x00,0x04,0x00,0x60,0x00,0x00,0x34,0x00,0x40,0x00,0xf8,0x0e,0x00,0x02,
  0x00,0x10,0x00,0x00,0x18,0x00,0x40,0x00,0xf8,0x6f,0x00,0x02,0x00,0x0c,0x00,0x00,
  0x10,0x00,0x40,0x00,0xf8,0x6f,0x80,0x01,0x00,0x02,0x00,0x08,0x00,0x00,0x40,0x00,
  0xf8,0x6f,0x80,0x00,0x80,0x01,0x80,0x08,0x00,0x00,0x40,0x00,0xf8,0x0f,0x80,0x00,
  0x40,0x00,0x40,0x10,0x00,0x00,0x40,0x00,0xff,0xff,0x80,0x00,0x30,0x00,0x30,0x20,
  0x00,0x00,0x40,0x00,0xff,0xff,0x80,0x00,0x18,0x00,0x0f,0xc0,0x00,0x00,0x40,0x00,
  0xff,0xff,0x80,0x00,0x0c,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0xff,0xff,0x80,0x00,
  0x0f,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0xe0,0x03,0x80,0x00,0x0f,0x80,0x00,0x00,
  0x00,0x00,0x80,0x00,0xe7,0xf3,0xe0,0x00,0x3f,0xe0,0x00,0x00,0x00,0x00,0x80,0x00,
  0xe0,0x03,0x9c,0x00,0xcb,0xfc,0x00,0x00,0x00,0x00,0x80,0x00,0xe7,0xf3,0x83,0x87,
  0x0b,0xff,0xc1,0xc0,0x00,0x00,0xc0,0x00,0xe0,0x03,0x80,0x78,0x09,0xff,0x02,0x20,
  0x00,0x00,0xe0,0x00,0xe0,0x03,0x80,0x00,0x08,0xf8,0x02,0x20,0x00,0x00,0xb0,0x00,
  0xff,0xff,0x80,0x00,0x08,0x00,0x04,0x20,0x00,0x00,0xd8,0x00,0x00,0x20,0x00,0x00,
  0x08,0x00,0x04,0x20,0x00,0x00,0xac,0x00,0x00,0x10,0x00,0x00,0x10,0x00,0x7c,0x20,
  0x00,0x00,0x54,0x00,0x00,0x08,0x00,0x00,0x10,0x00,0x82,0x20,0x00,0x00,0x6a,0x00,
  0x00,0x04,0x00,0x00,0x10,0x01,0x00,0x10,0x00,0x00,0x76,0x00,0x00,0x02,0x00,0x00,
  0x10,0x01,0x00,0x10,0x00,0x00,0x2b,0x00,0x00,0x01,0x80,0x04,0x50,0x02,0x00,0x0c,
  0x00,0x00,0x35,0x00,0x00,0x00,0x40,0x00,0x10,0x02,0x00,0x03,0x80,0x00,0x1a,0x80,
  0x00,0x00,0x35,0x15,0x50,0x02,0x00,0x00,0x70,0x00,0x15,0x80,0x00,0x00,0x18,0x00,
  0x10,0x02,0x00,0x00,0x0e,0x00,0x0a,0xc0,0x00,0x00,0x05,0x55,0x50,0x02,0x00,0x00,
  0x01,0x80,0x0d,0x40,0x00,0x00,0x03,0xa0,0xb0,0x01,0x00,0x00,0x00,0x40,0x0a,0xa0,
  0x00,0x00,0x00,0xd5,0x50,0x00,0x80,0x00,0x00,0x00,0x0d,0x60,0x00,0x00,0x00,0x3a,
  0xa8,0x00,0x60,0x00,0x00,0x00,0x06,0xb0,0x00,0x00,0x00,0x07,0x58,0x00,0x18,0x00,
  0x00,0x00,0x05,0x50,0x00,0x00,0x00,0x00,0xf8,0x00,0x1c,0x00,0x00,0x00,0x06,0xb0,
  0x00,0x00,0x00,0x00,0x08,0x00,0x1f,0x00,0x00,0x00,0x05,0x50,0x00,0x00,0x00,0x00,
  0x08,0x00,0x0f,0xc0,0x00,0x00,0x06,0xb0
};

static const unsigned char PROGMEM image_DolphinMafia_bits[] = {
  0x00,0x00,0x00,0x00,0x0f,0xfc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x70,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x07,0x80,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x7f,0xfe,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0f,0xaa,
  0x80,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x75,0x55,0x00,
  0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xaa,0xaa,0xa8,0x00,
  0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x55,0x54,0x00,0x00,0x20,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0xaa,0xaa,0xaa,0x00,0x10,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x05,0x55,0x54,0x00,0x00,0x10,0xff,0xfc,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0xaa,0xaa,0xaa,0x00,0x1f,0x00,0x03,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x05,0x55,0x54,0x00,0x00,0x08,0x00,0x00,0x80,0x00,
  0x00,0x00,0x00,0x00,0x00,0x06,0xaa,0xaa,0xaa,0x00,0x08,0x00,0x00,0x80,0x00,0x00,
  0x00,0x00,0x00,0x00,0x05,0x55,0x54,0x00,0x00,0x04,0x00,0x00,0x80,0x00,0x00,0x00,
  0x00,0x00,0x00,0x06,0xab,0xff,0xff,0xfc,0x04,0x00,0x03,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x05,0x5f,0xff,0xff,0xff,0xff,0xc0,0x1c,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x06,0xff,0xff,0xff,0xff,0xff,0xff,0xe0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x07,0xff,0xff,0xfd,0x55,0x55,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0f,
  0xff,0xff,0xea,0xaa,0xaa,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3f,0xff,
  0xff,0x55,0x40,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xfa,
  0xa8,0x00,0x00,0xe0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xff,0xff,0xf5,0x40,
  0x1f,0xf0,0xf0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xff,0xff,0xaa,0x80,0xff,
  0xf8,0xf0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xff,0xff,0x54,0x03,0xf0,0x1f,
  0xf0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0f,0xff,0xfa,0xa8,0x0f,0xf0,0x1f,0xf0,
  0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x1f,0xff,0xf5,0x40,0x1f,0xf0,0x38,0x70,0xf8,
  0x00,0x00,0x00,0x00,0x00,0x06,0x3f,0xff,0xea,0xa8,0x1f,0xf8,0x78,0x7f,0x06,0x00,
  0x00,0x00,0x6b,0x00,0x0a,0x7f,0xff,0xd5,0xff,0xff,0xff,0xf0,0xf0,0x01,0x00,0x00,
  0x01,0x80,0x13,0x72,0x7f,0xff,0xaf,0xe8,0x0f,0xff,0xf3,0x00,0x00,0x80,0x00,0x02,
  0x00,0x00,0x04,0xff,0xff,0xdf,0x00,0x07,0xff,0xe0,0x00,0x06,0x80,0x00,0x04,0x00,
  0x00,0x18,0xff,0xff,0xba,0xa0,0x03,0xff,0xc0,0x00,0x0e,0x87,0xe0,0x05,0xc5,0x0d,
  0x60,0xff,0xff,0x55,0x00,0x01,0xff,0x80,0x00,0x3f,0x80,0x00,0x06,0x00,0x00,0x00,
  0xff,0xff,0xba,0xa0,0x03,0xfe,0x00,0x00,0xcd,0x00,0x00,0x04,0x00,0x00,0x00,0x7f,
  0xff,0x75,0x00,0x04,0x06,0x00,0x03,0x01,0x00,0xf8,0x00,0x00,0x00,0x00,0x3f,0xf9,
  0xaa,0xa0,0x08,0x02,0x00,0x0c,0x01,0x00,0x00,0x70,0x00,0x00,0x00,0x00,0x01,0x55,
  0x00,0x08,0x00,0x00,0x30,0x01,0x00,0x00,0x88,0x00,0x00,0x00,0x00,0x01,0xaa,0xa0,
  0x00,0x00,0x00,0xc0,0x02,0x00,0x01,0x08,0x00,0x00,0x00,0x00,0x01,0x55,0x00,0x00,
  0x40,0x01,0x00,0x04,0x00,0x02,0x08,0x00,0x00,0x00,0x00,0x00,0xaa,0xa0,0x00,0x40,
  0x06,0x00,0x08,0x00,0x02,0x08,0x00,0x00,0x00,0x00,0x00,0xd5,0x00,0x00,0x30,0x18,
  0x00,0x30,0x00,0x04,0x10,0x00,0x00,0x00,0x00,0x00,0xaa,0xa8,0x00,0x0f,0xe0,0x00,
  0xc0,0x03,0x88,0x10,0x00,0x00,0x00,0x00,0x00,0xd5,0x00,0x00,0x00,0x00,0x03,0x00,
  0x04,0x68,0x78,0x00,0x00,0x00,0x00,0x00,0xaa,0xa8,0x00,0x00,0x00,0x0c,0x00,0x04,
  0x10,0x84,0x00,0x00,0x00,0x00,0x01,0xd5,0x00,0x00,0x00,0x00,0x30,0x00,0x04,0x01,
  0x02,0x00,0x00,0x00,0x00,0x02,0xba,0xa8,0x00,0x00,0x00,0xc0,0x00,0x02,0x01,0x01,
  0x00,0x00,0x00,0x00,0x03,0x57,0x40,0x00,0x00,0x03,0xe0,0x00,0x02,0x02,0x00,0x80,
  0x00,0x00,0x00,0x02,0xaa,0xea,0x00,0x00,0x1f,0xe0,0x00,0x01,0x02,0x00,0x80,0x00,
  0x00,0x00,0x03,0x55,0x5c,0x00,0x00,0x7f,0xa0,0x00,0x01,0x02,0x00,0x80,0x00,0x00,
  0x00,0x07,0xaa,0xab,0x80,0x00,0x3f,0xa0,0x00,0x01,0x01,0x01,0x00,0x00,0x00,0x00,
  0x0f,0xd5,0x50,0x78,0x00,0x0e,0x30,0x00,0x01,0x00,0x81,0x00,0x00,0x00,0x00,0x1b,
  0xea,0xaa,0x87,0x80,0x00,0x28,0x00,0x01,0x00,0x42,0x00,0x00,0x00,0x00,0x37,0xf5,
  0x50,0x00,0x7f,0xe0,0x28,0x00,0x07,0x00,0x3e,0x00,0x00,0x00,0x00,0x4f,0xfe,0xaa,
  0xa0,0x00,0x18,0x24,0x00,0x08,0x80,0x04,0x00,0x00,0x00,0x00,0xd7,0xff,0x50,0x00,
  0x00,0x04,0x44,0x00,0x10,0x40,0x04,0x00,0x00,0x00,0x00,0xaf,0xff,0xaa,0xa0,0x00,
  0x12,0x44,0x00,0x20,0x20,0x08,0x00,0x00,0x00,0x01,0x5f,0xff,0xf0,0x00,0x00,0x31,
  0x42,0x00,0x60,0x10,0x10,0x00,0x00,0x00,0x02,0xaf,0xff,0xfa,0xa8,0x00,0x60,0xd2,
  0x01,0x90,0x0c,0x20,0x00,0x00,0x00,0x03,0x5f,0xff,0x57,0x00,0x00,0xe0,0x4a,0x02,
  0x08,0x03,0x60,0x00,0x00,0x00,0x06,0xaf,0xfe,0xaa,0xe8,0x01,0xf0,0x4e,0x0c,0x04,
  0x00,0xe0,0x00,0x00,0x00,0x0d,0x5f,0xfd,0x55,0x1c,0x03,0xf8,0x2f,0x35,0x42,0x00,
  0x20,0x00,0x00,0x00,0x0a,0xaf,0xfa,0xaa,0xab,0x87,0xfc,0x2e,0xea,0x81,0x80,0x40,
  0x00,0x00,0x00,0x15,0x5f,0xf5,0x55,0x01,0xcf,0xfe,0x1f,0x55,0x50,0x60,0x80,0x00,
  0x00,0x00
};

static const unsigned char PROGMEM image_DeleteBasket_bits[] = {
  0x00,0x3f,0x00,0x00,0x00,0x3f,0x00,0x00,0x03,0xc0,0xf0,0x00,0x03,0xc0,0xf0,0x00,
  0xf3,0xff,0xf3,0xc0,0xf3,0xff,0xf3,0xc0,0xff,0xff,0xff,0xc0,0xff,0xff,0xff,0xc0,
  0xf0,0x00,0x03,0xc0,0xf0,0x00,0x03,0xc0,0x30,0x00,0x03,0x00,0x30,0x00,0x03,0x00,
  0x30,0x00,0x03,0x00,0x30,0x00,0x03,0x00,0x3c,0x00,0x0f,0x00,0x3c,0x00,0x0f,0x00,
  0x0c,0xcc,0xcc,0x00,0x0c,0xcc,0xcc,0x00,0x0c,0xcc,0xcc,0x00,0x0c,0xcc,0xcc,0x00,
  0x0c,0xcc,0xcc,0x00,0x0c,0xcc,0xcc,0x00,0x0c,0xcc,0xcc,0x00,0x0c,0xcc,0xcc,0x00,
  0x0c,0xcc,0xcc,0x00,0x0c,0xcc,0xcc,0x00,0x0c,0x00,0x0c,0x00,0x0c,0x00,0x0c,0x00,
  0x03,0xff,0xf0,0x00,0x03,0xff,0xf0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};



static String explorerBasename(const String& path) {
  int slash = path.lastIndexOf('/');
  if (slash >= 0) return path.substring(slash + 1);
  return path;
}

static bool explorerIsHidden(const String& name) {
  return name.length() > 0 && name[0] == '.';
}

static bool explorerMatchesExtension(const String& name, const ExplorerConfig& cfg) {
  if (cfg.extCount == 0 || cfg.extensions == nullptr) return true;
  for (uint8_t i = 0; i < cfg.extCount; i++) {
    if (name.endsWith(cfg.extensions[i])) return true;
  }
  return false;
}

void ExplorerInit(ExplorerState& state, ExplorerEntry* buffer, int bufferSize, const ExplorerConfig& cfg) {
  state.list = buffer;
  state.maxFiles = bufferSize;
  state.count = 0;
  state.index = 0;
  state.currentDir = cfg.rootDir ? cfg.rootDir : "";
  state.inExplorer = true;
  state.inDeleteConfirm = false;
  state.selectedFile = "";
}

void ExplorerLoad(ExplorerState& state, const ExplorerConfig& cfg) {
  state.count = 0;
  if (state.currentDir.length() == 0 && cfg.rootDir) {
    state.currentDir = cfg.rootDir;
  }
  if (cfg.createRoot && cfg.rootDir && !SD.exists(cfg.rootDir)) {
    SD.mkdir(cfg.rootDir);
  }

  File dir = SD.open(state.currentDir);
  if (!dir) {
    Serial.print(F("Failed to open directory: "));
    Serial.println(state.currentDir);
    return;
  }

  if (cfg.includeDirs) {
    while (state.count < state.maxFiles) {
      File entry = dir.openNextFile();
      if (!entry) break;
      if (entry.isDirectory()) {
        String name = explorerBasename(entry.name());
        if (!cfg.skipHidden || !explorerIsHidden(name)) {
          state.list[state.count].name = name;
          state.list[state.count].isDir = true;
          state.count++;
        }
      }
      entry.close();
    }
  }

  dir.rewindDirectory();
  while (state.count < state.maxFiles) {
    File entry = dir.openNextFile();
    if (!entry) break;
    if (!entry.isDirectory()) {
      String name = explorerBasename(entry.name());
      if ((!cfg.skipHidden || !explorerIsHidden(name)) && explorerMatchesExtension(name, cfg)) {
        state.list[state.count].name = name;
        state.list[state.count].isDir = false;
        state.count++;
      }
    }
    entry.close();
  }
  dir.close();
}

void ExplorerDraw(const ExplorerState& state, DisplayType& display) {
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextWrap(false);
  display.setTextColor(SH110X_WHITE);

  display.setCursor(3, 3);
  display.print(state.currentDir);

  display.setCursor(1, 12);
  display.println(F("---------------------"));

  if (state.count == 0) {
    display.setCursor(38, 32);
    display.println(F("No files."));
    display.display();
    return;
  }

  const int perPage = 4;
  int maxStart = (state.count > perPage) ? (state.count - perPage) : 0;
  int startIndex = state.index - 1;
  if (startIndex < 0) startIndex = 0;
  if (startIndex > maxStart) startIndex = maxStart;

  int itemsToShow = state.count - startIndex;
  if (itemsToShow > perPage) itemsToShow = perPage;

  const int baseRow = 2;
  for (int i = 0; i < itemsToShow; i++) {
    int idx = startIndex + i;
    String name = state.list[idx].name;
    if (name.length() > 18) name = name.substring(0, 18);

    int y = (i + baseRow) * 11;

    if (idx == state.index) {
      display.fillRect(0, y - 1, 128, 11, SH110X_WHITE);
      display.setTextColor(SH110X_BLACK);
    } else {
      display.setTextColor(SH110X_WHITE);
    }
    display.setCursor(3, y);
    display.println(name);
  }
  display.display();
}

void ExplorerDrawDeleteConfirm(const ExplorerState& state, DisplayType& display) {
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SH110X_WHITE);
  display.setTextWrap(false);
  display.setCursor(3, 3);
  String name = state.list[state.index].name;
  if (name.length() > 16) name = name.substring(0, 16);
  display.print("File: " + name);
  display.setCursor(32, 19);
  display.print("Press OK to");
  display.drawBitmap(51, 32, image_DeleteBasket_bits, 26, 32, 1);
  display.display();
}

void ExplorerDrawSaveResult(DisplayType& display) {
  display.clearDisplay();
  display.drawBitmap(16, 6, image_DolphinSaved_bits, 92, 58, SH110X_WHITE);
  display.setTextColor(SH110X_WHITE);
  display.setTextWrap(false);
  display.setCursor(6, 16);
  display.print(F("Saved"));
  display.display();
}

static bool explorerDeleteSelected(const ExplorerState& state) {
  if (state.count == 0) return false;
  String filePath = state.currentDir + "/" + state.list[state.index].name;
  if (state.list[state.index].isDir) {
    return SD.rmdir(filePath);
  }
  return SD.remove(filePath);
}

static void explorerShowDeleteResult(DisplayType& display, bool ok) {
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SH110X_WHITE);
  display.setTextWrap(false);
  if (ok) {
    display.drawBitmap(5, 2, image_DolphinMafia_bits, 119, 62, SH110X_WHITE);
    display.setCursor(84, 15);
    display.print(F("Deleted"));
  } else {
    display.setCursor(1, 1);
    display.print(F("Failed to delete"));
  }
  display.display();
  delay(1000);
}

ExplorerAction ExplorerHandle(ExplorerState& state, const ExplorerConfig& cfg, DisplayType& display,
                              bool upClick, bool downClick, bool okClick, bool backClick, bool backHold) {
  if (state.inDeleteConfirm) {
    if (okClick) {
      bool ok = explorerDeleteSelected(state);
      explorerShowDeleteResult(display, ok);
      state.inDeleteConfirm = false;
      if (ok) {
        if (state.count > 0) {
          for (int i = state.index; i < state.count - 1; i++) {
            state.list[i] = state.list[i + 1];
          }
          state.count--;
          if (state.count == 0) {
            state.index = 0;
          } else if (state.index >= state.count) {
            state.index = state.count - 1;
          }
        }
      }
      ExplorerDraw(state, display);
      return ok ? EXPLORER_DELETED : EXPLORER_DELETE_FAILED;
    }
    if (backClick) {
      state.inDeleteConfirm = false;
      ExplorerDraw(state, display);
      return EXPLORER_DELETE_CANCEL;
    }
    return EXPLORER_NONE;
  }

  if (upClick && state.count > 0) {
    state.index = (state.index == 0) ? (state.count - 1) : state.index - 1;
    ExplorerDraw(state, display);
  }
  if (downClick && state.count > 0) {
    state.index = (state.index == state.count - 1) ? 0 : state.index + 1;
    ExplorerDraw(state, display);
  }
  if (okClick && state.count > 0) {
    if (state.list[state.index].isDir) {
      state.currentDir += "/" + state.list[state.index].name;
      state.index = 0;
      state.count = 0;
      ExplorerLoad(state, cfg);
      ExplorerDraw(state, display);
      return EXPLORER_ENTER_DIR;
    }
    state.selectedFile = state.list[state.index].name;
    return EXPLORER_SELECT_FILE;
  }
  if (backHold && cfg.allowDelete && state.count > 0) {
    state.inDeleteConfirm = true;
    ExplorerDrawDeleteConfirm(state, display);
    return EXPLORER_DELETE_PROMPT;
  }
  if (backClick) {
    if (cfg.rootDir && state.currentDir != cfg.rootDir) {
      int lastSlash = state.currentDir.lastIndexOf('/');
      state.currentDir = state.currentDir.substring(0, lastSlash);
      if (state.currentDir == "") state.currentDir = cfg.rootDir;
      state.index = 0;
      state.count = 0;
      ExplorerLoad(state, cfg);
      ExplorerDraw(state, display);
      return EXPLORER_ENTER_DIR;
    }
    return EXPLORER_EXIT;
  }

  return EXPLORER_NONE;
}
